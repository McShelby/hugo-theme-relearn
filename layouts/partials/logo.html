{{- $classes := dict "lightbox" "false" }}
{{- $title := "" }}
{{- if isset site.Params "linktitle" }}
  {{- $title = site.Params.linkTitle | default " " }}
{{- end }}
{{- if not (len $title) }}
  {{- $title = site.Title }}
{{- end }}
{{- $title = trim $title "\n\r\t " }}

{{- $direction := site.Params.logo.direction | default "row" }}

{{- /* Determine default/global logo */}}
{{- $hasDefaultLogo := false }}
{{- $defaultLogoSrc := "" }}
{{- with site.Params.logo }}
  {{- if isset site.Params.logo "src" }}
    {{- $hasDefaultLogo = true }}
    {{- $defaultLogoSrc = trim site.Params.logo.src "\n\r\t " }}
  {{- end }}
{{- end }}

{{- /* Auto-detect if no default specified */}}
{{- if not $hasDefaultLogo }}
  {{- $svg := dict "ext" "svg" "type" "type=\"image/svg+xml\"" }}
  {{- $webp := dict "ext" "webp" "type" "type=\"image/webp\"" }}
  {{- $png := dict "ext" "png" "type" "type=\"image/png\"" }}
  {{- $jpg := dict "ext" "jpg" "type" "type=\"image/jpeg\"" }}
  {{- $jpeg := dict "ext" "jpeg" "type" "type=\"image/jpeg\"" }}
  {{- $gif := dict "ext" "gif" "type" "type=\"image/gif\"" }}
  {{- $imageTypes := slice $svg $webp $png $jpg $jpeg $gif }}
  {{- $imageNames := slice "logo" }}
  {{- range $imageNames }}
    {{- $imageName := . }}
    {{- range $imageTypes }}
      {{- $imageType := . }}
      {{- with resources.Get (printf "/images/%s.%s" $imageName $imageType.ext) }}
        {{- $hasDefaultLogo = true }}
        {{- $defaultLogoSrc = printf "/images/%s.%s" $imageName $imageType.ext }}
      {{- end }}
      {{- if $hasDefaultLogo }}
        {{- break }}
      {{- end }}
    {{- end }}
    {{- if $hasDefaultLogo }}
      {{- break }}
    {{- end }}
  {{- end }}
{{- end }}

{{- /* Build map of variant logos */}}
{{- $logoMap := dict }}
{{- $themevariants := partialCached "_relearn/themeVariants.gotmpl" . }}
{{- range $themevariants }}
  {{- $variant := . }}
  {{- $logoSrc := $defaultLogoSrc }}

  {{- /* Only non-auto variants can have logo overrides */}}
  {{- if not (isset $variant "auto") }}
    {{- if isset $variant "logo" }}
      {{- if isset $variant.logo "src" }}
        {{- $logoSrc = trim $variant.logo.src "\n\r\t " }}
      {{- end }}
    {{- end }}
    {{- if $logoSrc }}
      {{- $logoMap = merge $logoMap (dict $variant.identifier (dict "src" $logoSrc "variant" $variant.identifier)) }}
    {{- end }}
  {{- end }}
{{- end }}

{{- /* Group logos by source */}}
{{- $logoGroups := dict }}
{{- range $variantId, $logoInfo := $logoMap }}
  {{- $src := $logoInfo.src }}
  {{- $existingVariants := slice }}
  {{- if isset $logoGroups $src }}
    {{- $existingVariants = index $logoGroups $src }}
  {{- end }}
  {{- $existingVariants = $existingVariants | append $variantId }}
  {{- $logoGroups = merge $logoGroups (dict $src $existingVariants) }}
{{- end }}

{{- /* Render logo container with all variants */}}
{{- if or $logoGroups $title }}
        <a id="R-logo" class="R-default direction-{{ $direction }}" href="{{ partial "permalink.gotmpl" (dict "to" site.Home) }}">
    {{- range $logoSrc, $variants := $logoGroups }}
      {{- $variantList := delimit $variants " " }}
      {{- $parsedURL := urls.Parse $logoSrc }}
      {{- $queryParts := slice }}
      {{- range $k, $v := $parsedURL.Query }}
        {{- range $v }}
          {{- $queryParts = $queryParts | append (querify $k .) }}
        {{- end }}
      {{- end }}
      {{- range $k, $v := $classes }}
        {{- $queryParts = $queryParts | append (querify $k $v) }}
      {{- end }}
      {{- $baseURL := $parsedURL.Path }}
      {{- if $parsedURL.Scheme }}
        {{- $baseURL = printf "%s://%s%s" $parsedURL.Scheme $parsedURL.Host $parsedURL.Path }}
      {{- end }}
      {{- with $queryParts }}
        {{- $logoSrc = printf "%s?%s" $baseURL (delimit . "&") }}
      {{- else }}
        {{- $logoSrc = $baseURL }}
      {{- end }}
      {{- with $parsedURL.Fragment }}
        {{- $logoSrc = printf "%s#%s" $logoSrc . }}
      {{- end }}
          <span class="logo-image default-animation" data-r-logo-variant="{{ $variantList }}">
{{ partial "shortcodes/image.html" (dict "page" site.Home "url" $logoSrc) }}
          </span>
    {{- end }}
    {{- with $title }}
          <span class="logo-title default-animation">{{ . }}</span>
    {{- end }}
        </a>
{{- end }}